<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mestre das Equa√ß√µes</title>
    
    <!-- Configura√ß√£o MathJax -->
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']], 
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      svg: { fontCache: 'global' },
      startup: {
        typeset: false 
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --primary: #4a90e2;
            --secondary: #50e3c2;
            --accent: #ff6b6b;
            --background: #f4f7f6;
            --text: #2c3e50;
            --card-bg: #ffffff;
            --hint-bg: #fff0f0;
            --study-color: #f39c12;
            --balance-color: #34495e;
            --board-color: #ffeaa7;
            --cert-gold: #f1c40f;
            /* Tiles Colors */
            --tile-pos-x: #2ecc71; /* Green */
            --tile-neg-x: #e74c3c; /* Red */
            --tile-pos-1: #f1c40f; /* Yellow */
            --tile-neg-1: #e74c3c; /* Red */
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--background); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 95%; max-width: 800px; margin-top: 20px; text-align: center; padding-bottom: 40px; }
        
        /* Cards & Layout */
        .card { background: var(--card-bg); border-radius: 15px; padding: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.3s ease; }
        .hidden { display: none !important; }
        .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; justify-content: center; }
        .col { flex: 1; min-width: 200px; }

        /* Typography */
        h1 { color: var(--primary); margin-bottom: 0.5em; }
        h2 { color: var(--primary); font-size: 1.4rem; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;}
        h3 { color: #34495e; font-size: 1.1rem; margin-top: 25px; font-weight: 700;}

        /* Buttons */
        .btn { background-color: var(--primary); color: white; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 50px; cursor: pointer; margin: 5px; transition: transform 0.1s, background 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: inline-block; font-weight: 600; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn:active { transform: translateY(0); }
        .btn-secondary { background-color: #95a5a6; }
        .btn-accent { background-color: var(--accent); }
        .btn-game { background-color: #9b59b6; }
        .btn-study { background-color: var(--study-color); }
        .btn-cert { background-color: var(--cert-gold); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .btn-small { font-size: 0.85rem; padding: 5px 15px; }
        .btn-large { padding: 15px 30px; font-size: 1.2rem; min-width: 150px; }
        .btn-true { background-color: #27ae60; }
        .btn-false { background-color: #c0392b; }
        .btn-option { background-color: white; color: var(--text); border: 2px solid #e0e0e0; width: 100%; text-align: left; margin: 5px 0; border-radius: 10px; padding: 15px; transition: all 0.2s; }
        .btn-option:hover { background-color: #f9f9f9; border-color: var(--primary); }
        .btn-option.selected-correct { background-color: #d4edda; border-color: #27ae60; color: #155724; }
        .btn-option.selected-wrong { background-color: #f8d7da; border-color: #721c24; color: #721c24; }
        .btn-disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; transform: none !important; opacity: 0.7; }

        /* --- ALGEBRA TILES STYLES --- */
        .tiles-workspace { display: flex; gap: 10px; margin-top: 20px; min-height: 250px; }
        .tiles-panel { flex: 1; border: 2px dashed #bdc3c7; border-radius: 10px; padding: 10px; background: #fafafa; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 5px; position: relative; transition: background 0.3s; }
        .tiles-panel h4 { width: 100%; margin: 0 0 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; color: #7f8c8d; }
        .tile { display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-family: monospace; box-shadow: 1px 1px 3px rgba(0,0,0,0.3); cursor: pointer; user-select: none; transition: transform 0.2s, opacity 0.5s; }
        .tile:hover { transform: scale(1.1); }
        .tile-x { width: 20px; height: 60px; background-color: var(--tile-pos-x); }
        .tile-neg-x { width: 20px; height: 60px; background-color: var(--tile-neg-x); }
        .tile-1 { width: 20px; height: 20px; background-color: var(--tile-pos-1); }
        .tile-neg-1 { width: 20px; height: 20px; background-color: var(--tile-neg-1); }
        .tile-label { position: absolute; font-size: 0.7rem; pointer-events: none; }
        
        /* --- GRAPH STYLES --- */
        canvas#graphCanvas { border: 1px solid #ddd; background-color: #fff; width: 100%; max-width: 500px; height: 300px; border-radius: 8px; }
        .graph-controls input[type=range] { width: 100px; margin: 0 5px; }

        /* --- PREVIOUS STYLES --- */
        .flashcard-container { perspective: 1000px; width: 100%; max-width: 500px; height: 300px; margin: 20px auto; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .flashcard-container.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; border-radius: 15px; }
        .flashcard-front { background-color: white; color: var(--text); border: 2px solid var(--study-color); }
        .flashcard-back { background-color: var(--study-color); color: white; transform: rotateY(180deg); }
        .flashcard-content { font-size: 1.3rem; line-height: 1.5; }
        .flashcard-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; opacity: 0.8; }
        .report-stats { display: flex; justify-content: space-around; margin: 20px 0; flex-wrap: wrap; }
        .stat-box { background: #f8f9fa; padding: 15px; border-radius: 10px; min-width: 80px; margin: 5px; text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase; }
        .review-item { text-align: left; padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px; }
        .certificate-container { border: 10px solid var(--primary); padding: 40px; position: relative; background: #fff url('data:image/svg+xml;utf8,<svg width="100" height="100" transform="rotate(25)" opacity="0.05" version="1.1" xmlns="http://www.w3.org/2000/svg"><text x="10" y="50" font-size="60">üéì</text></svg>'); text-align: center; color: #333; font-family: 'Georgia', serif; }
        .cert-header { font-size: 2.5rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        .cert-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 40px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 20px 0; }
        .status-bar { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; color: #7f8c8d; }
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 10px; margin: 15px 0; height: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--secondary); width: 0%; transition: width 0.5s ease; }
        .equation-display { font-size: 1.8rem; margin: 20px 0; padding: 20px; background-color: #f8f9fa; border-radius: 10px; border-left: 5px solid var(--primary); }
        .feedback { margin-top: 15px; padding: 15px; border-radius: 8px; display: none; text-align: left; line-height: 1.6; }
        .correct { background-color: #d4edda; color: #155724; }
        .incorrect { background-color: #f8d7da; color: #721c24; }
        input[type="number"] { padding: 10px; font-size: 1.2rem; border: 2px solid #bdc3c7; border-radius: 8px; width: 100px; text-align: center; }
        .balance-container { display: flex; flex-direction: column; align-items: center; margin: 20px auto; height: 180px; width: 100%; max-width: 400px; position: relative; }
        .balance-beam { width: 80%; height: 6px; background-color: var(--balance-color); position: relative; top: 50px; transition: transform 0.5s ease; transform-origin: center; }
        .tilt-left { transform: rotate(-15deg); } .tilt-right { transform: rotate(15deg); } .balanced { transform: rotate(0deg); }
        .balance-fulcrum { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 40px solid var(--balance-color); position: absolute; top: 56px; left: 50%; transform: translateX(-50%); }
        .pan { width: 80px; height: 5px; background-color: var(--balance-color); position: absolute; top: 30px; }
        .pan-left { left: 0; } .pan-right { right: 0; }
        .pan-string { width: 2px; height: 30px; background-color: #bdc3c7; position: absolute; top: 0; }
        .string-l1 { left: 0; } .string-l2 { left: 80px; } .string-r1 { right: 0; } .string-r2 { right: 80px; }
        .pan-plate { width: 100px; height: 10px; background-color: #95a5a6; border-radius: 0 0 50px 50px; position: absolute; top: 30px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 5px; flex-wrap: wrap-reverse; gap: 2px; transition: transform 0.5s ease; }
        .plate-left { left: -10px; } .plate-right { right: -10px; }
        .weight-box { width: 25px; height: 25px; background-color: var(--primary); color: white; display: flex; align-items: center; justify-content: center; border-radius: 3px; font-size: 0.9rem; font-family: 'Times New Roman', serif; font-style: italic; font-weight: bold; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); margin: 1px; }
        .weight-circle { width: 20px; height: 20px; background-color: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); margin: 1px; }
        .lab-controls-top { background: #e1f0ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .control-group { display: flex; align-items: center; justify-content: space-between; background: white; padding: 5px 10px; border-radius: 5px; margin-bottom: 5px; border: 1px solid #eee; }
        .board-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin: 20px auto; max-width: 400px; }
        .board-cell { aspect-ratio: 1; background-color: var(--board-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; position: relative; font-size: 0.9rem; }
        .board-cell.start { background-color: #55efc4; } .board-cell.finish { background-color: #fab1a0; }
        .player-token { width: 20px; height: 20px; background-color: var(--primary); border: 2px solid white; border-radius: 50%; position: absolute; z-index: 10; transition: all 0.5s ease; }
        .memory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin: 20px 0; }
        .memory-card { aspect-ratio: 3/4; background-color: var(--primary); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; transition: transform 0.3s; }
        .memory-card.flipped { background-color: white; color: var(--text); border: 2px solid var(--primary); transform: rotateY(180deg); font-size: 1rem; }
        .memory-card.matched { background-color: #d4edda; border-color: #27ae60; color: #27ae60; cursor: default; }
        .domino-table { background-color: #2c3e50; min-height: 120px; border-radius: 10px; padding: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-bottom: 20px; }
        .domino-piece { display: flex; width: 100px; height: 50px; background-color: white; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s; }
        .domino-piece:hover { transform: translateY(-2px); }
        .domino-half { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border-right: 1px solid #ccc; padding: 2px; }
        .domino-half:last-child { border-right: none; }
        .domino-piece.on-table { cursor: default; transform: none; margin: 2px; }
        .bingo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px auto; max-width: 300px; }
        .bingo-cell { aspect-ratio: 1; background-color: white; border: 2px solid var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .bingo-cell.marked { background-color: var(--secondary) !important; color: white !important; border-color: #2ecc71 !important; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 0; border-radius: 15px; max-width: 700px; width: 95%; height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { display: flex; background-color: #f1f2f6; border-bottom: 1px solid #ddd; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 15px 10px; border: none; background: none; cursor: pointer; font-weight: bold; color: #7f8c8d; transition: 0.3s; white-space: nowrap; }
        .tab-btn.active { background-color: white; color: var(--primary); border-bottom: 3px solid var(--primary); }
        .modal-body { padding: 30px; overflow-y: auto; text-align: left; flex-grow: 1; }
        .zoomable-img { cursor: zoom-in; transition: transform 0.3s ease; }
        .zoomable-img.zoomed { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 2000; object-fit: contain; background-color: rgba(0,0,0,0.9); padding: 20px; box-sizing: border-box; cursor: zoom-out; max-width: none !important; border: none !important; }
        
        .detective-step { background: #fff; border: 2px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; text-align: left; transition: all 0.2s; display: flex; align-items: center; }
        .detective-step:hover { border-color: var(--primary); background-color: #f0f8ff; }
        .detective-step.error-found { border-color: #27ae60; background-color: #d4edda; color: #155724; }
        .detective-step.error-missed { border-color: #c0392b; background-color: #f8d7da; }
        .step-number { font-weight: bold; color: #95a5a6; margin-right: 15px; min-width: 30px; }
        
        .solver-history { margin: 20px 0; padding: 15px; background: #fdfdfd; border-radius: 10px; border: 1px solid #eee; max-height: 200px; overflow-y: auto; text-align: left; }
        .solver-step-log { padding: 5px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; color: #555; }
        .solver-controls { background: #e1f0ff; padding: 20px; border-radius: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; }
        .op-btn { width: 40px; height: 40px; border-radius: 50%; font-weight: bold; font-size: 1.2rem; padding: 0; display: flex; align-items: center; justify-content: center; }
        
        footer { margin-top: 20px; font-size: 0.8rem; color: #7f8c8d; padding-top: 10px; border-top: 1px solid #eee; width: 100%; text-align: center; }
        @media print {
            body * { visibility: hidden; }
            #screen-certificate, #screen-certificate * { visibility: visible; }
            #screen-certificate { position: absolute; left: 0; top: 0; width: 100%; margin: 0; border: none; box-shadow: none; }
            .btn-noprint { display: none; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="font-weight: bold; font-size: 1.2rem; color: var(--text);">‚öñÔ∏è EquaMaster</div>
            <button class="btn btn-secondary btn-small" onclick="openGuide()">üìò Guia de Estudo</button>
        </div>

        <!-- MENU INICIAL -->
        <div id="screen-menu" class="card">
            <h1>Aventura Alg√©brica</h1>
            <p>Domina a arte do equil√≠brio e resolve problemas com rigor matem√°tico.</p>
            <br>
            <div style="display: flex; flex-direction: column; gap: 10px; max-width: 320px; margin: 0 auto;">
                <button class="btn" onclick="startGame()">üöÄ Iniciar Jornada</button>
                <button class="btn btn-accent" onclick="showLabMenu()">üß™ Laborat√≥rio</button>
                <button class="btn btn-game" onclick="showGamesMenu()">üéÆ Sala de Jogos</button>
                <button class="btn btn-study" onclick="showStudyMenu()">üß† Estudo & Revis√£o</button>
                <button id="btn-cert-main" class="btn btn-cert btn-disabled" onclick="showCertificate()" disabled>üèÜ Certificado</button>
            </div>
            <p style="font-size: 0.9rem; color: #7f8c8d; margin-top: 20px;">Dica: Consulta o novo Guia de Estudo!</p>
        </div>

        <!-- MENU JOGOS -->
        <div id="screen-games-menu" class="card hidden">
            <button class="btn btn-secondary btn-small" onclick="showMenu()" style="float: left;">‚¨Ö Voltar</button>
            <h1 style="clear: both; margin-top: 10px;">Sala de Jogos</h1>
            <p>Escolhe o teu desafio l√∫dico:</p>
            <div class="row">
                <button class="btn btn-game col" onclick="startBoardGame()">üé≤ Tabuleiro</button>
                <button class="btn btn-game col" onclick="startMemoryGame()">üß† Mem√≥ria</button>
            </div>
            <div class="row">
                <button class="btn btn-game col" onclick="startDominoGame()">üÅö Domin√≥</button>
                <button class="btn btn-game col" onclick="startBingoGame()">üé± Bingo</button>
            </div>
            <div class="row">
                <button class="btn btn-game col" onclick="startDetective()">üïµÔ∏è Detetive de Erros</button>
            </div>
        </div>

        <!-- MENU LAB -->
        <div id="screen-lab-menu" class="card hidden">
            <button class="btn btn-secondary btn-small" onclick="showMenu()" style="float: left;">‚¨Ö Voltar</button>
            <h1 style="clear: both; margin-top: 10px;">Laborat√≥rio</h1>
            <p>Experimenta e descobre:</p>
            <div class="row">
                <button class="btn btn-accent col" onclick="startLab()">‚öñÔ∏è Balan√ßa Visual</button>
                <button class="btn btn-accent col" onclick="startSolver()">‚öôÔ∏è Resolvedor Interativo</button>
            </div>
            <div class="row">
                <button class="btn btn-accent col" onclick="startTiles()">üü¶ Azulejos de √Ålgebra</button>
                <button class="btn btn-accent col" onclick="startGraph()">üìà Conex√£o Gr√°fica</button>
            </div>
        </div>

        <!-- MENU ESTUDO -->
        <div id="screen-study-menu" class="card hidden">
            <button class="btn btn-secondary btn-small" onclick="showMenu()" style="float: left;">‚¨Ö Voltar</button>
            <h1 style="clear: both; margin-top: 10px;">Estudo & Revis√£o</h1>
            <p>Consolida os teus conhecimentos:</p>
            <div class="row">
                <button class="btn btn-study col" onclick="startFlashcards()">üóÇÔ∏è Flashcards</button>
                <button class="btn btn-study col" onclick="startVF()">‚úÖ Verdadeiro ou Falso</button>
            </div>
            <div class="row">
                <button class="btn btn-study col" onclick="startQuiz()">üìù Quiz Geral</button>
            </div>
        </div>

        <!-- *** SCREEN: TILES LAB *** -->
        <div id="screen-lab-tiles" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-secondary btn-small" onclick="showLabMenu()">‚¨Ö Sair</button><h2>üü¶ Azulejos de √Ålgebra</h2><div style="width: 80px;"></div></div>
            <p>Visualiza n√∫meros negativos e forma pares nulos. Tenta representar: $2x - 3 = -x + 6$</p>
            
            <div class="tiles-workspace">
                <div class="tiles-panel" id="tiles-left" style="border-color: #3498db;">
                    <h4>1.¬∫ Membro (Esquerda)</h4>
                </div>
                <div style="display: flex; align-items: center; font-size: 2rem; color: #7f8c8d;">=</div>
                <div class="tiles-panel" id="tiles-right" style="border-color: #e67e22;">
                    <h4>2.¬∫ Membro (Direita)</h4>
                </div>
            </div>

            <div class="row" style="background: #eee; padding: 10px; border-radius: 10px; margin-top: 10px;">
                <div class="col">
                    <strong>Adicionar √† Esquerda:</strong><br>
                    <button class="btn btn-small" style="background: var(--tile-pos-x)" onclick="addTile('left', 'x', 1)">+x</button>
                    <button class="btn btn-small" style="background: var(--tile-neg-x)" onclick="addTile('left', 'x', -1)">-x</button>
                    <button class="btn btn-small" style="background: var(--tile-pos-1)" onclick="addTile('left', '1', 1)">+1</button>
                    <button class="btn btn-small" style="background: var(--tile-neg-1)" onclick="addTile('left', '1', -1)">-1</button>
                </div>
                <div class="col">
                    <strong>Adicionar √† Direita:</strong><br>
                    <button class="btn btn-small" style="background: var(--tile-pos-x)" onclick="addTile('right', 'x', 1)">+x</button>
                    <button class="btn btn-small" style="background: var(--tile-neg-x)" onclick="addTile('right', 'x', -1)">-x</button>
                    <button class="btn btn-small" style="background: var(--tile-pos-1)" onclick="addTile('right', '1', 1)">+1</button>
                    <button class="btn btn-small" style="background: var(--tile-neg-1)" onclick="addTile('right', '1', -1)">-1</button>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-game" onclick="simplifyTiles()">üí• Anular Pares Nulos</button>
                <button class="btn btn-secondary" onclick="resetTiles()">Limpar Tudo</button>
            </div>
            <div id="tiles-equation-display" style="font-size: 1.2rem; margin-top: 15px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd;"></div>
            <p id="tiles-feedback" style="height: 20px; font-weight: bold; color: var(--primary);"></p>
        </div>

        <!-- *** SCREEN: GRAPH LAB *** -->
        <div id="screen-lab-graph" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-secondary btn-small" onclick="showLabMenu()">‚¨Ö Sair</button><h2>üìà Conex√£o Gr√°fica</h2><div style="width: 80px;"></div></div>
            <p>A solu√ß√£o da equa√ß√£o $ax + b = cx + d$ √© a interse√ß√£o das retas.</p>
            
            <div class="graph-controls" style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                <div style="margin-bottom: 10px; color: #2980b9;">
                    <strong>Reta 1 ($y = ax + b$):</strong> 
                    a: <input type="range" id="graph-a" min="-5" max="5" step="0.5" value="2" oninput="updateGraph()"> <span id="val-a">2</span>
                    b: <input type="range" id="graph-b" min="-5" max="5" step="1" value="1" oninput="updateGraph()"> <span id="val-b">1</span>
                </div>
                <div style="color: #c0392b;">
                    <strong>Reta 2 ($y = cx + d$):</strong> 
                    c: <input type="range" id="graph-c" min="-5" max="5" step="0.5" value="0" oninput="updateGraph()"> <span id="val-c">0</span>
                    d: <input type="range" id="graph-d" min="-5" max="5" step="1" value="5" oninput="updateGraph()"> <span id="val-d">5</span>
                </div>
            </div>

            <div style="position: relative; margin: auto;">
                <canvas id="graphCanvas" width="500" height="300"></canvas>
                <div id="graph-intersection-label" style="position: absolute; background: rgba(255,255,255,0.9); padding: 5px; border: 1px solid #333; border-radius: 4px; pointer-events: none; display: none;"></div>
            </div>
            
            <div id="graph-equation" style="font-size: 1.2rem; margin-top: 10px; font-weight: bold;"></div>
        </div>

        <!-- EXISTING SCREENS -->
        <!-- SOLVER -->
        <div id="screen-lab-solver" class="card hidden">
             <div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-secondary btn-small" onclick="showLabMenu()">‚¨Ö Sair</button><h2>‚öôÔ∏è Resolvedor Interativo</h2><div style="width: 80px;"></div></div>
             <p>Usa as opera√ß√µes para isolar o $x$. Mant√©m a balan√ßa equilibrada!</p>
             <div class="equation-display" id="solver-display" style="font-size: 2rem; margin: 20px 0;"></div>
             <div class="solver-controls">
                 <div style="display: flex; align-items: center; gap: 10px;">
                     <span>Opera√ß√£o:</span>
                     <button class="btn op-btn" onclick="setSolverOp('add')" title="Somar">+</button><button class="btn op-btn" onclick="setSolverOp('sub')" title="Subtrair">-</button><button class="btn op-btn" onclick="setSolverOp('mul')" title="Multiplicar">√ó</button><button class="btn op-btn" onclick="setSolverOp('div')" title="Dividir">√∑</button>
                 </div>
                 <div style="display: flex; align-items: center; gap: 10px;">
                     <span>Valor:</span><input type="number" id="solver-val" style="width: 60px;" placeholder="?"><button class="btn" onclick="applySolverOp()">Aplicar</button>
                 </div>
             </div>
             <div class="solver-history" id="solver-log"><div class="solver-step-log" style="font-style: italic;">In√≠cio da resolu√ß√£o...</div></div>
             <button class="btn btn-secondary" onclick="initSolver()">Nova Equa√ß√£o Aleat√≥ria</button>
        </div>
        
        <!-- DETECTIVE -->
        <div id="screen-game-detective" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-secondary btn-small" onclick="showGamesMenu()">Sair</button><h2>üïµÔ∏è Detetive de Erros</h2><div style="width: 50px;"></div></div>
            <p>O aluno cometeu um erro. <strong>Clica na linha</strong> onde o erro apareceu pela primeira vez.</p>
            <div id="detective-case-container" style="margin-top: 20px;"></div>
            <div id="detective-feedback" class="feedback" style="margin-top: 20px;"></div>
            <button id="detective-next-btn" class="btn hidden" onclick="nextDetectiveCase()">Pr√≥ximo Caso ‚û°</button>
        </div>

        <!-- FLASHCARDS -->
        <div id="screen-flashcards" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-secondary btn-small" onclick="showStudyMenu()">Sair</button><span>Cart√£o <strong id="fc-counter">1</strong> / <span id="fc-total"></span></span></div>
            <div class="flashcard-container" onclick="flipFlashcard()"><div class="flashcard-inner" id="flashcard-inner"><div class="flashcard-front"><div class="flashcard-label">Pergunta / Conceito</div><div class="flashcard-content" id="fc-front"></div><div style="margin-top: 20px; font-size: 0.8rem; color: #999;">(Clica para virar)</div></div><div class="flashcard-back"><div class="flashcard-label">Resposta / Defini√ß√£o</div><div class="flashcard-content" id="fc-back"></div></div></div></div>
            <div style="margin-top: 20px;"><button class="btn btn-secondary" onclick="prevFlashcard()">‚¨Ö Anterior</button><button id="fc-next-btn" class="btn" onclick="nextFlashcard()">Pr√≥ximo ‚û°</button></div>
        </div>

        <!-- QUIZ & VF -->
        <div id="screen-vf" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-secondary btn-small" onclick="showStudyMenu()">Sair</button><span>Quest√£o <strong id="vf-q-num">1</strong>/10</span></div><div class="progress-container"><div id="vf-progress" class="progress-bar"></div></div>
            <div style="min-height: 150px; display: flex; flex-direction: column; justify-content: center;"><p id="vf-question" style="font-size: 1.3rem; font-weight: bold; margin: 20px 0;"></p><p id="vf-hint" style="color: #7f8c8d; font-style: italic; font-size: 0.9rem; display: none;"></p></div>
            <div id="vf-buttons"><button class="btn btn-large btn-true" onclick="checkVF(true)">Verdadeiro (V)</button><button class="btn btn-large btn-false" onclick="checkVF(false)">Falso (F)</button></div>
            <div id="vf-feedback" class="feedback" style="margin-top: 20px;"></div><button id="vf-next-btn" class="btn" onclick="nextVF()">Pr√≥xima Quest√£o ‚û°</button>
        </div>
        <div id="screen-quiz" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-secondary btn-small" onclick="showStudyMenu()">Sair</button><span>Quest√£o <strong id="quiz-q-num">1</strong>/10</span></div><div class="progress-container"><div id="quiz-progress" class="progress-bar"></div></div>
            <div style="min-height: 120px;"><p id="quiz-question" style="font-size: 1.2rem; font-weight: bold; margin: 20px 0;"></p><p id="quiz-hint" style="color: #7f8c8d; font-style: italic; font-size: 0.9rem; margin-bottom: 15px;">üí° Dica: <span id="quiz-hint-text"></span></p></div>
            <div id="quiz-options"></div><div id="quiz-feedback" class="feedback" style="margin-top: 20px;"></div><button id="quiz-next-btn" class="btn" onclick="nextQuiz()">Pr√≥xima Quest√£o ‚û°</button>
        </div>
        <div id="screen-results-report" class="card hidden">
            <h1>Question√°rio Conclu√≠do!</h1>
            <div class="report-stats"><div class="stat-box"><span class="stat-label">Pontua√ß√£o</span><span class="stat-value" id="res-score"></span></div><div class="stat-box"><span class="stat-label">Precis√£o</span><span class="stat-value" id="res-accuracy"></span></div></div>
            <div class="report-stats" style="margin-top: 0;"><div class="stat-box" style="background-color: #d4edda; color: #155724;"><span class="stat-label">Corretas</span><span class="stat-value" id="res-correct">0</span></div><div class="stat-box" style="background-color: #f8d7da; color: #721c24;"><span class="stat-label">Erradas</span><span class="stat-value" id="res-wrong">0</span></div><div class="stat-box" style="background-color: #fff3cd; color: #856404;"><span class="stat-label">Ignoradas</span><span class="stat-value" id="res-skipped">0</span></div></div>
            <div id="res-review-container" class="hidden" style="margin: 20px 0;"><h3>Revis√£o do Question√°rio</h3><div id="res-review-list" style="text-align: left; max-height: 300px; overflow-y: auto; background: #fff; border-radius: 10px; padding: 10px;"></div></div>
            <button class="btn" onclick="toggleReview()">Rever question√°rio</button><button class="btn btn-secondary" onclick="restartCurrentQuiz()">Responder novamente</button><button class="btn btn-secondary" onclick="showStudyMenu()">Voltar ao Menu</button>
        </div>

        <!-- JORNADA, LAB, JOGOS -->
        <div id="screen-game" class="card hidden"><div class="status-bar"><span id="level-indicator">N√≠vel 1</span><span>‚ù§Ô∏è <span id="lives">3</span></span><span>‚≠ê <span id="score">0</span></span><button class="btn btn-secondary btn-small" onclick="showMenu()" style="margin: 0; padding: 2px 10px;">Sair</button></div><div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div><div id="balance-area" class="hidden"></div><div id="visual-text-area" class="visual-aid hidden"></div><p id="question-text" style="font-size: 1.1rem;"></p><div class="equation-display" id="question-equation"></div><div style="display: flex; justify-content: center; align-items: center; gap: 10px;"><span style="font-size: 1.5rem; font-family: 'Times New Roman', serif; font-style: italic;">x = </span><input type="number" id="user-input" autocomplete="off"></div><div id="visual-hint-wrapper" style="margin-top: 15px;"><button id="btn-visual-hint" class="btn btn-accent hidden" onclick="showVisualHint()">üëÅÔ∏è Ver Pista</button><div id="visual-hint-container" class="hidden"></div></div><div id="feedback-area" class="feedback"></div><div style="margin-top: 20px;"><button id="btn-check" class="btn" onclick="checkAnswer()">Verificar Solu√ß√£o</button><button id="btn-next" class="btn hidden" onclick="nextQuestion()">Pr√≥ximo Desafio ‚û°</button></div></div>
        <div id="screen-lab" class="card hidden"><div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-secondary btn-small" onclick="showLabMenu()">‚¨Ö Voltar</button><h2>üß™ Balan√ßa Visual</h2><div style="width: 80px;"></div></div><div class="lab-controls-top"><label>Valor de x:</label><input type="range" id="lab-x-value" min="1" max="10" value="5" oninput="updateLab()" style="width: 150px;"><span id="lab-x-display" style="font-weight: bold; font-size: 1.5rem; color: var(--accent); margin-left: 10px; width: 30px;">5</span></div><div id="lab-balance-area"></div><div class="equation-display" id="lab-equation" style="min-height: 80px; display: flex; align-items: center; justify-content: center;"></div><div class="row"><div class="col card" style="background: #f8f9fa; padding: 15px; margin: 0;"><h3 style="margin-top: 0;">Esquerda</h3><div class="control-group"><span>Caixas (x):</span><div><button class="btn btn-small btn-secondary" onclick="adjustLab('left', 'x', -1)">-</button><span id="count-left-x" style="font-weight: bold; margin: 0 5px;">0</span><button class="btn btn-small" onclick="adjustLab('left', 'x', 1)">+</button></div></div><div class="control-group"><span>Pesos (1):</span><div><button class="btn btn-small btn-secondary" onclick="adjustLab('left', 'u', -1)">-</button><span id="count-left-u" style="font-weight: bold; margin: 0 5px;">0</span><button class="btn btn-small" onclick="adjustLab('left', 'u', 1)">+</button></div></div></div><div class="col card" style="background: #f8f9fa; padding: 15px; margin: 0;"><h3 style="margin-top: 0;">Direita</h3><div class="control-group"><span>Caixas (x):</span><div><button class="btn btn-small btn-secondary" onclick="adjustLab('right', 'x', -1)">-</button><span id="count-right-x" style="font-weight: bold; margin: 0 5px;">0</span><button class="btn btn-small" onclick="adjustLab('right', 'x', 1)">+</button></div></div><div class="control-group"><span>Pesos (1):</span><div><button class="btn btn-small btn-secondary" onclick="adjustLab('right', 'u', -1)">-</button><span id="count-right-u" style="font-weight: bold; margin: 0 5px;">0</span><button class="btn btn-small" onclick="adjustLab('right', 'u', 1)">+</button></div></div></div></div></div>
        <div id="screen-game-board" class="card hidden"><div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-secondary btn-small" onclick="showGamesMenu()">Sair</button><h2>Corrida das Equa√ß√µes</h2><div style="width: 50px;"></div></div><div class="board-grid" id="board-container"></div><p id="board-message">Lan√ßa o dado para come√ßar!</p><button id="btn-roll-dice" class="btn btn-game" onclick="rollDice()">üé≤ Lan√ßar Dado</button></div>
        <div id="screen-game-memory" class="card hidden"><div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-secondary btn-small" onclick="showGamesMenu()">Sair</button><h2>Mem√≥ria Alg√©brica</h2><span>Pares: <strong id="memory-score">0</strong>/6</span></div><p>Encontra o par: Equa√ß√£o ‚Üî Solu√ß√£o</p><div class="memory-grid" id="memory-container"></div><button id="btn-restart-memory" class="btn hidden" onclick="startMemoryGame()">Jogar Novamente</button></div>
        <div id="screen-game-domino" class="card hidden"><div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-secondary btn-small" onclick="showGamesMenu()">Sair</button><h2>Domin√≥ de Equa√ß√µes</h2><div style="width: 50px;"></div></div><p>Liga a <strong>Solu√ß√£o</strong> de uma pe√ßa √† <strong>Equa√ß√£o</strong> da pr√≥xima.</p><div class="domino-table" id="domino-table"><span style="color: white; font-style: italic;">A mesa est√° vazia...</span></div><h3>A tua M√£o:</h3><div class="domino-hand" id="domino-hand"></div><p id="domino-msg" style="margin-top: 15px; color: var(--accent); font-weight: bold;"></p><button id="btn-restart-domino" class="btn hidden" onclick="startDominoGame()">Jogar Novamente</button></div>
        <div id="screen-game-bingo" class="card hidden"><div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-secondary btn-small" onclick="showGamesMenu()">Sair</button><h2>Bingo Alg√©brico</h2><div style="width: 50px;"></div></div><div class="bingo-ball"><span style="font-size: 0.9rem; color: #7f8c8d; text-transform: uppercase; font-weight: bold;">Chamada Atual</span><div id="bingo-current-call" style="font-size: 2rem; margin-top: 10px;"></div></div><p>Resolve a equa√ß√£o e marca o resultado na tua cartela!</p><div class="bingo-grid" id="bingo-card"></div><button id="btn-next-bingo" class="btn btn-game" onclick="nextBingoCall()">Sorteiar Pr√≥xima Equa√ß√£o üé±</button><div id="bingo-status" style="margin-top: 15px; font-weight: bold; min-height: 40px; padding: 10px;"></div></div>
        <div id="screen-report" class="card hidden"><h1>Jornada Conclu√≠da! üéâ</h1><p>Pontua√ß√£o Final: <strong id="final-score"></strong></p><div id="journey-review-container" class="hidden" style="margin: 20px 0;"><h3>Revis√£o da Jornada</h3><div id="report-details" style="text-align: left; max-height: 300px; overflow-y: auto; background: #fff; border-radius: 10px; padding: 10px;"></div></div><div style="margin-top: 20px;"><button class="btn" onclick="toggleJourneyReview()">Rever Jornada</button><button class="btn btn-secondary" onclick="startGame()">Jogar Novamente</button><button class="btn btn-secondary" onclick="showMenu()">Voltar ao Menu</button></div></div>
        <div id="screen-certificate" class="card hidden" style="max-width: 700px; background-color: #fff;"><div class="certificate-container"><div class="cert-header">Certificado de Excel√™ncia</div><div class="cert-sub">Mestre das Equa√ß√µes</div><div class="cert-body">Certifica-se que<br><input type="text" class="cert-name" placeholder="Escreva o seu nome aqui" style="border: none; border-bottom: 2px solid #333; font-size: 1.5rem; text-align: center; margin: 10px 0; background: transparent; width: 80%;"><br>concluiu com sucesso todas as etapas da forma√ß√£o em Equa√ß√µes de 1.¬∫ Grau.</div><div class="cert-stats-grid"><div class="cert-stat"><strong>Jornada</strong><span id="cert-score-jornada">0</span>%</div><div class="cert-stat"><strong>Verdadeiro/Falso</strong><span id="cert-score-vf">0</span>%</div><div class="cert-stat"><strong>Quiz Geral</strong><span id="cert-score-quiz">0</span>%</div></div><div class="cert-grade-box"><strong>Avalia√ß√£o Global: </strong> <span id="cert-score-global" style="font-size: 1.2rem; color: var(--primary);">0</span>%<br><span id="cert-grade" style="text-transform: uppercase; font-weight: bold; letter-spacing: 1px; color: #333; font-size: 1.1rem; margin-top: 5px; display: inline-block;"></span></div><div class="cert-footer"><div class="cert-seal">TOP<br>SCORE</div><div><div id="cert-date">Data: </div><div style="margin-top: 5px; font-weight: bold;">Assinatura Digital: EquaMaster App</div></div></div></div><div style="margin-top: 20px;" class="btn-noprint"><button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button><button class="btn btn-secondary" onclick="showMenu()">Voltar</button></div></div>
        
        <footer>Teod√≥sio Faria ¬© 2025 EquaMaster - Aventura Alg√©brica</footer>
    </div>

    <!-- MODAIS & GUIA -->
    <div id="modal-board-question" class="modal"><div class="modal-content" style="max-height: auto; height: auto; padding: 20px;"><h3>Desafio do Tabuleiro</h3><div id="board-q-text" style="font-size: 1.2rem; margin: 15px 0;"></div><input type="number" id="board-input" placeholder="x = ?"><div id="board-feedback" style="margin: 10px; font-weight: bold;"></div><button class="btn" onclick="checkBoardAnswer()">Responder</button></div></div>
    <div id="modal-guide" class="modal"><div class="modal-content"><div class="modal-header"><button class="tab-btn active" onclick="switchTab('tab-def')">1. Defini√ß√µes</button><button class="tab-btn" onclick="switchTab('tab-solve')">2. Resolver</button><button class="tab-btn" onclick="switchTab('tab-act')">3. Atividades</button><button class="tab-btn" onclick="switchTab('tab-prob')">4. Problemas</button><button class="tab-btn" onclick="switchTab('tab-plan')">5. Plano</button></div><div id="tab-def" class="modal-body"><h2>O que √© uma Equa√ß√£o?</h2><div class="definition-box"><strong>Defini√ß√£o:</strong> "Equa√ß√£o √© uma igualdade em que aparece uma letra (ou mais) que representa um valor desconhecido. √Ä letra que representa o valor desconhecido chama-se inc√≥gnita."</div><h3>Disseca√ß√£o de uma Equa√ß√£o</h3><div class="example-box" style="text-align: center;">$$ 7x + 3 = 0 $$<ul style="text-align: left; margin-top: 15px; list-style-type: none;"><li>üî¥ <strong>7x</strong>: Termo Dependente (cont√©m a inc√≥gnita)</li><li>üîµ <strong>3</strong>: Termo Independente (n√∫mero "sozinho")</li><li>üü¢ <strong>7</strong>: Coeficiente da inc√≥gnita (o que multiplica o x)</li></ul></div></div><div id="tab-solve" class="modal-body hidden"><h2>Exemplo Resolvido Passo a Passo</h2><p><strong>Equa√ß√£o:</strong> $5x + 3 = 38$</p><ol><li><strong>Isolar o termo dependente:</strong> Subtrair 3 a ambos os membros.<br>$$5x + 3 - 3 = 38 - 3 \Rightarrow 5x = 35$$</li><li><strong>Isolar a inc√≥gnita:</strong> Dividir ambos os membros por 5.<br>$$5x : 5 = 35 : 5 \Rightarrow x = 7$$</li><li><strong>Solu√ß√£o:</strong> A raiz da equa√ß√£o √© 7.</li></ol></div><div id="tab-act" class="modal-body hidden"><h2>Atividades</h2><div class="activity-item"><strong>1.</strong> $x + 5 = 8$ <button class="btn btn-small btn-secondary" onclick="toggleAns('ans1')">Ver Resolu√ß√£o</button><div id="ans1" class="hidden">1. Subtrair 5 a ambos os lados: $$x = 8 - 5$$<br>2. Resultado: $$x = 3$$</div></div><div class="activity-item"><strong>2.</strong> $x - 7 = -7$ <button class="btn btn-small btn-secondary" onclick="toggleAns('ans2')">Ver Resolu√ß√£o</button><div id="ans2" class="hidden">1. Somar 7 a ambos os lados: $$x = -7 + 7$$<br>2. Resultado: $$x = 0$$</div></div></div><div id="tab-prob" class="modal-body hidden"><h2>Problemas</h2><div class="activity-item"><p>O dobro de um n√∫mero somado com 5 √© 91.</p><button class="btn btn-small btn-secondary" onclick="toggleAns('sol1')">Ver Resolu√ß√£o</button><div id="sol1" class="hidden">1. Tradu√ß√£o: $$2x + 5 = 91$$<br>2. Subtrair 5: $$2x = 91 - 5 \Rightarrow 2x = 86$$<br>3. Dividir por 2: $$x = 86 : 2 \Rightarrow x = 43$$</div></div></div><div id="tab-plan" class="modal-body hidden"><h2>Plano de Aula</h2><p>Clique na imagem.</p><div style="text-align: center;"><img src="./infografia-plano.jpg" alt="Infografia" class="zoomable-img" onclick="toggleZoom(this)" style="max-width: 100%; border-radius: 8px;"></div></div><div style="padding: 15px; text-align: center; border-top: 1px solid #ddd;"><button class="btn" style="margin: 0;" onclick="closeGuide()">Fechar Guia</button></div></div></div>

    <script>
        function typeset() { if(window.MathJax && window.MathJax.typesetPromise) window.MathJax.typesetPromise(); }

        // --- NAV & SETUP ---
        const allScreens = ['screen-menu', 'screen-games-menu', 'screen-study-menu', 'screen-lab-menu', 'screen-lab-tiles', 'screen-lab-graph', 'screen-game-board', 'screen-game-memory', 'screen-game-domino', 'screen-game-bingo', 'screen-game-detective', 'screen-game', 'screen-lab', 'screen-lab-solver', 'screen-report', 'screen-flashcards', 'screen-vf', 'screen-quiz', 'screen-results-report', 'screen-certificate'];
        function hideAllScreens() { allScreens.forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); }); }
        function showMenu() { hideAllScreens(); document.getElementById('screen-menu').classList.remove('hidden'); checkCertificateUnlock(); }
        function showGamesMenu() { hideAllScreens(); document.getElementById('screen-games-menu').classList.remove('hidden'); }
        function showStudyMenu() { hideAllScreens(); document.getElementById('screen-study-menu').classList.remove('hidden'); }
        function showLabMenu() { hideAllScreens(); document.getElementById('screen-lab-menu').classList.remove('hidden'); }
        function openGuide() { document.getElementById('modal-guide').style.display = 'flex'; typeset(); }
        function closeGuide() { document.getElementById('modal-guide').style.display = 'none'; }
        function switchTab(id) { ['tab-def', 'tab-solve', 'tab-act', 'tab-prob', 'tab-plan'].forEach(i => document.getElementById(i).classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(id).classList.remove('hidden'); event.target.classList.add('active'); }
        function toggleAns(id) { const el = document.getElementById(id); el.classList.toggle('hidden'); typeset(); }
        function toggleZoom(img) { img.classList.toggle('zoomed'); }

        // --- TILES LAB ---
        let tilesState = { left: [], right: [] }; // Arrays of 'x', '1', '-x', '-1'
        function startTiles() {
            hideAllScreens(); document.getElementById('screen-lab-tiles').classList.remove('hidden');
            resetTiles();
        }
        function resetTiles() {
            tilesState = { left: [], right: [] };
            renderTiles();
            document.getElementById('tiles-feedback').innerText = "";
        }
        function addTile(side, type, sign) {
            // sign 1 or -1. Type 'x' or '1'
            const tileVal = (sign === 1 ? '' : '-') + type;
            tilesState[side].push(tileVal);
            renderTiles();
        }
        function renderTiles() {
            ['left', 'right'].forEach(side => {
                const container = document.getElementById(`tiles-${side}`);
                container.innerHTML = `<h4>${side === 'left' ? '1.¬∫ Membro' : '2.¬∫ Membro'}</h4>`;
                tilesState[side].forEach(tile => {
                    const el = document.createElement('div');
                    el.className = `tile tile-${tile === '-x' ? 'neg-x' : (tile === '-1' ? 'neg-1' : (tile === 'x' ? 'x' : '1'))}`;
                    el.innerText = tile;
                    container.appendChild(el);
                });
            });
            updateTilesEquation();
        }
        
        function updateTilesEquation() {
            // Calculate algebraic representation
            const getSideVal = (side) => {
                let x = 0, u = 0;
                tilesState[side].forEach(t => {
                    if (t === 'x') x++;
                    else if (t === '-x') x--;
                    else if (t === '1') u++;
                    else if (t === '-1') u--;
                });
                return { x, u };
            };

            const l = getSideVal('left');
            const r = getSideVal('right');

            const formatSide = (s) => {
                let str = "";
                if (s.x !== 0) str += (s.x === 1 ? "x" : (s.x === -1 ? "-x" : `${s.x}x`));
                if (s.u !== 0) {
                    if (s.u > 0 && str !== "") str += " + ";
                    str += s.u;
                }
                if (str === "") str = "0";
                return str;
            };

            const eqStr = `$$ ${formatSide(l)} = ${formatSide(r)} $$`;
            document.getElementById('tiles-equation-display').innerHTML = "<strong>Representa√ß√£o Atual:</strong> " + eqStr;
            typeset();

            // Check for solution
            // Scenario 1: x = k or k = x
            if ((l.x === 1 && l.u === 0 && r.x === 0) || (r.x === 1 && r.u === 0 && l.x === 0)) {
                document.getElementById('tiles-feedback').innerHTML = "üéâ Solu√ß√£o Encontrada!";
            } else if ((l.x === -1 && l.u === 0 && r.x === 0) || (r.x === -1 && r.u === 0 && l.x === 0)) {
                 document.getElementById('tiles-feedback').innerHTML = "Quase! Tens -x. Troca os sinais ou divide por -1.";
            } else if (l.x !== 0 && l.u === 0 && r.x === 0 && r.u !== 0) {
                // Scenario: ax = b
                document.getElementById('tiles-feedback').innerHTML = `Tens ${l.x}x = ${r.u}. Divide ${r.u} por ${l.x} para achar x!`;
            } else {
                document.getElementById('tiles-feedback').innerHTML = "";
            }
        }

        function simplifyTiles() {
            // Logic: Remove pairs of (x, -x) and (1, -1) from EACH side separately
            let changed = false;
            ['left', 'right'].forEach(side => {
                const arr = tilesState[side];
                // Count
                let x = 0, negX = 0, one = 0, negOne = 0;
                arr.forEach(t => {
                    if(t==='x') x++; else if(t==='-x') negX++; else if(t==='1') one++; else if(t==='-1') negOne++;
                });
                
                const pairsX = Math.min(x, negX);
                const pairs1 = Math.min(one, negOne);
                
                if (pairsX > 0 || pairs1 > 0) {
                    changed = true;
                    // Rebuild array without pairs
                    const newArr = [];
                    for(let i=0; i<x-pairsX; i++) newArr.push('x');
                    for(let i=0; i<negX-pairsX; i++) newArr.push('-x');
                    for(let i=0; i<one-pairs1; i++) newArr.push('1');
                    for(let i=0; i<negOne-pairs1; i++) newArr.push('-1');
                    tilesState[side] = newArr;
                }
            });
            
            renderTiles();
            const fb = document.getElementById('tiles-feedback');
            // If already showing solution text, keep it, otherwise show "Pairs removed"
            if (!fb.innerText.includes("Solu√ß√£o") && !fb.innerText.includes("Tens")) {
                 if (changed) fb.innerText = "Pares nulos removidos! ‚ú®";
                 else fb.innerText = "N√£o h√° pares nulos para remover (do mesmo lado).";
                 setTimeout(() => { if(fb.innerText.includes("Pares")) fb.innerText = ""; }, 2000);
            }
        }

        // --- GRAPH LAB ---
        function startGraph() {
            hideAllScreens(); document.getElementById('screen-lab-graph').classList.remove('hidden');
            updateGraph();
        }
        function updateGraph() {
            const a = parseFloat(document.getElementById('graph-a').value);
            const b = parseFloat(document.getElementById('graph-b').value);
            const c = parseFloat(document.getElementById('graph-c').value);
            const d = parseFloat(document.getElementById('graph-d').value);

            document.getElementById('val-a').innerText = a;
            document.getElementById('val-b').innerText = b;
            document.getElementById('val-c').innerText = c;
            document.getElementById('val-d').innerText = d;

            // Equation Display
            const eqStr = `$$ ${a}x ${b>=0?'+':''} ${b} = ${c}x ${d>=0?'+':''} ${d} $$`;
            const eqEl = document.getElementById('graph-equation');
            eqEl.innerHTML = eqStr;
            typeset();

            // Draw Canvas
            const cvs = document.getElementById('graphCanvas');
            const ctx = cvs.getContext('2d');
            const w = cvs.width, h = cvs.height;
            
            // Clear
            ctx.clearRect(0, 0, w, h);
            
            // Coordinate System (Center is w/2, h/2)
            // Scale: 20px = 1 unit
            const scale = 20;
            const cx = w/2, cy = h/2;

            // Draw Axes
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(w, cy); ctx.stroke(); // X axis
            ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, h); ctx.stroke(); // Y axis

            // Draw Line 1: y = ax + b
            ctx.strokeStyle = '#2980b9'; ctx.lineWidth = 2;
            drawLine(ctx, x => a*x + b, scale, cx, cy, w, h);

            // Draw Line 2: y = cx + d
            ctx.strokeStyle = '#c0392b'; ctx.lineWidth = 2;
            drawLine(ctx, x => c*x + d, scale, cx, cy, w, h);

            // Calculate Intersection: ax+b = cx+d => x(a-c) = d-b => x = (d-b)/(a-c)
            if (a !== c) {
                const intersectX = (d - b) / (a - c);
                const intersectY = a * intersectX + b;
                
                // Draw Point
                const px = cx + intersectX * scale;
                const py = cy - intersectY * scale;
                
                ctx.fillStyle = '#27ae60';
                ctx.beginPath(); ctx.arc(px, py, 5, 0, 2*Math.PI); ctx.fill();
                
                // Label
                const label = document.getElementById('graph-intersection-label');
                label.style.display = 'block';
                label.style.left = (px + 10) + 'px';
                label.style.top = (py - 20) + 'px';
                label.innerText = `x = ${intersectX.toFixed(2)}`;
            } else {
                document.getElementById('graph-intersection-label').style.display = 'none';
            }
        }

        function drawLine(ctx, func, scale, cx, cy, w, h) {
            ctx.beginPath();
            // Iterate pixels width
            let first = true;
            for (let col = 0; col < w; col+=5) {
                const mathX = (col - cx) / scale;
                const mathY = func(mathX);
                const row = cy - mathY * scale;
                if (first) { ctx.moveTo(col, row); first = false; }
                else { ctx.lineTo(col, row); }
            }
            ctx.stroke();
        }

        // --- UPDATED DETECTIVE LOGIC (VARIED STEPS) ---
        const detectiveCases = [
            {steps:["$$3x+5=17$$","$$3x=12$$","$$x=12-3$$","$$x=9$$"], errorIdx:2, explanation:"Erro de Opera√ß√£o! O 3 estava a multiplicar, deveria passar a dividir ($$x=12/3$$)."},
            {steps:["$$x/2 = 6$$","$$x = 6-2$$","$$x = 4$$"], errorIdx:1, explanation:"Erro na Transposi√ß√£o! O 2 estava a dividir, deveria passar a multiplicar ($$x=6 \\times 2$$)."},
            {steps:["$$-2x = 10$$","$$x = 10+2$$","$$x = 12$$"], errorIdx:1, explanation:"Erro de Opera√ß√£o! O -2 estava a multiplicar, deveria passar a dividir mantendo o sinal ($$x=10/-2$$)."},
            {steps:["$$4x+2=2x+10$$","$$4x+2x=10-2$$","$$6x=8$$","$$x=8/6$$"], errorIdx:1, explanation:"Erro de Sinal! O termo $2x$ era positivo, ao mudar de membro devia ficar negativo ($$4x-2x$$)."},
            {steps:["$$5(x+2)=20$$","$$5x+2=20$$","$$5x=18$$","$$x=18/5$$"], errorIdx:1, explanation:"Erro na Propriedade Distributiva! O 5 tem de multiplicar por ambos os termos ($$5x+10$$)."}
        ];

        let currentDetectiveCase=0;
        function startDetective(){hideAllScreens();document.getElementById('screen-game-detective').classList.remove('hidden');currentDetectiveCase=0;loadDetectiveCase();}
        function loadDetectiveCase(){const d=detectiveCases[currentDetectiveCase];const c=document.getElementById('detective-case-container');c.innerHTML='';document.getElementById('detective-feedback').style.display='none';document.getElementById('detective-next-btn').classList.add('hidden');d.steps.forEach((s,i)=>{const e=document.createElement('div');e.className='detective-step';e.innerHTML=`<span class="step-number">${i+1}.</span> ${s}`;e.onclick=()=>checkDetectiveStep(e,i);c.appendChild(e);});typeset();}
        function checkDetectiveStep(el,i){const d=detectiveCases[currentDetectiveCase];const fb=document.getElementById('detective-feedback');document.querySelectorAll('.detective-step').forEach(e=>e.style.pointerEvents='none');if(i===d.errorIdx){el.classList.add('error-found');fb.innerHTML=`<strong>Bem observado!</strong><br>${d.explanation}`;fb.className='feedback correct';document.getElementById('detective-next-btn').classList.remove('hidden');}else{el.classList.add('error-missed');fb.innerHTML='<strong>N√£o foi aqui...</strong>';fb.className='feedback incorrect';setTimeout(()=>{document.querySelectorAll('.detective-step').forEach(e=>{e.style.pointerEvents='auto';e.classList.remove('error-missed');});},1500);}fb.style.display='block';}
        function nextDetectiveCase(){currentDetectiveCase++;if(currentDetectiveCase<detectiveCases.length)loadDetectiveCase();else{alert("Parab√©ns! Completaste todos os casos!");showGamesMenu();}}

        let solverState={a:0,b:0,c:0},solverOp='';
        function startSolver(){initSolver();hideAllScreens();document.getElementById('screen-lab-solver').classList.remove('hidden');}
        function initSolver(){const x=Math.floor(Math.random()*9)+1;solverState.a=Math.floor(Math.random()*4)+2;solverState.b=Math.floor(Math.random()*10)+1;solverState.c=(solverState.a*x)+solverState.b;document.getElementById('solver-log').innerHTML='<div class="solver-step-log">In√≠cio...</div>';updateSolverDisplay();}
        function updateSolverDisplay(){const s=solverState.b>=0?'+':'-',bv=Math.abs(solverState.b);let eq=(solverState.a===1?'x':(solverState.a!==0?`${solverState.a}x`:0));if(solverState.b!==0)eq+=` ${s} ${bv}`;else if(solverState.a===0)eq='0';eq+=` = ${solverState.c}`;document.getElementById('solver-display').innerHTML=`$$${eq}$$`;typeset();}
        function setSolverOp(o){solverOp=o;document.querySelectorAll('.op-btn').forEach(b=>b.style.background='var(--primary)');event.target.style.background='var(--accent)';document.getElementById('solver-val').focus();}
        function applySolverOp(){const v=parseFloat(document.getElementById('solver-val').value);if(isNaN(v)||!solverOp)return;let txt="";if(solverOp==='add'){solverState.b+=v;solverState.c+=v;txt=`Somar ${v}`;}else if(solverOp==='sub'){solverState.b-=v;solverState.c-=v;txt=`Subtrair ${v}`;}else if(solverOp==='mul'){solverState.a*=v;solverState.b*=v;solverState.c*=v;txt=`Multiplicar por ${v}`;}else if(solverOp==='div'){solverState.a=parseFloat((solverState.a/v).toFixed(2));solverState.b=parseFloat((solverState.b/v).toFixed(2));solverState.c=parseFloat((solverState.c/v).toFixed(2));txt=`Dividir por ${v}`;}const l=document.getElementById('solver-log');l.innerHTML+=`<div class="solver-step-log"><strong>${txt}:</strong> ${document.getElementById('solver-display').innerText}</div>`;updateSolverDisplay();if(Math.abs(solverState.b)<0.01&&Math.abs(solverState.a-1)<0.01)l.innerHTML+=`<div class="solver-step-log" style="color:green;">Solu√ß√£o: x = ${solverState.c} üéâ</div>`;document.getElementById('solver-val').value='';solverOp='';document.querySelectorAll('.op-btn').forEach(b=>b.style.background='var(--primary)');}

        // --- DATA & STATE (QUIZ, JORNADA, ETC.) ---
        const quizData=[{q:"Na fun√ß√£o afim definida por $f(x)=ax+b$, qual √© o significado geom√©trico do coeficiente angular '$a$'?",options:["A inclina√ß√£o ou declive da reta no plano cartesiano.","O ponto em que a reta interseta o eixo y.","O ponto em que a reta interseta o eixo x.","Um valor constante que representa a parte fixa da fun√ß√£o."],correct:0,hint:"Pense em como este coeficiente afeta se a reta sobe ou desce da esquerda para a direita."},{q:"Ao resolver a equa√ß√£o $5x-8=2x+13$ utilizando o princ√≠pio aditivo, qual √© o passo inicial correto para agrupar os termos com a inc√≥gnita '$x$' no primeiro membro?",options:["Adicionar $2x$ a ambos os membros.","Dividir ambos os membros por $5$.","Adicionar $8$ a apenas um membro.","Subtrair $2x$ de ambos os membros."],correct:3,hint:"Para mover um termo de um lado da igualdade para o outro, deve-se aplicar a sua opera√ß√£o inversa em ambos os lados."},{q:"Se, ap√≥s simplificar algebricamente uma equa√ß√£o, se chega √† forma $0 \\cdot x = 8$, qual √© a classifica√ß√£o do seu conjunto-solu√ß√£o?",options:["Imposs√≠vel, com o conjunto-solu√ß√£o vazio.","Poss√≠vel e indeterminado, com infinitas solu√ß√µes.","A solu√ß√£o √© $x=8$.","Poss√≠vel e determinado, com uma solu√ß√£o √∫nica."],correct:0,hint:"Analise se existe algum valor para 'x' que possa tornar a igualdade 0=8 verdadeira."},{q:"O custo mensal de um servi√ßo de internet √© uma taxa fixa de 50,00 ‚Ç¨ mais 0,10 ‚Ç¨ por MB consumido. Qual fun√ß√£o descreve o custo total $V(x)$?",options:["$V(x)=50x+0,10$","$V(x)=0,10x+50$","$V(x)=50,10x$","$V(x)=50-0,10x$"],correct:1,hint:"Identifique qual valor √© a 'parte fixa' e qual √© a 'parte que varia'."},{q:"O que representa a raiz, ou o zero, de uma fun√ß√£o afim $f(x)=ax+b$?",options:["O valor de $x$ onde o gr√°fico interseta o eixo y.","O valor de $x$ onde o gr√°fico interseta o eixo x.","O valor inicial da fun√ß√£o.","A taxa de crescimento da fun√ß√£o."],correct:1,hint:"A 'raiz' √© o valor que resulta em f(x)=0."},{q:"Qual √© o primeiro passo recomendado para resolver $\\frac{x}{3} - 4 = \\frac{x}{2}$?",options:["Calcular o MMC dos denominadores (3 e 2) e multiplicar todos os termos.","Multiplicar cruzado os termos $2x$ e $2$, e $3$ e $x$.","Isolar o termo com $x$ somando $4$.","Subtrair $\\frac{x}{2}$ de ambos os membros."],correct:0,hint:"Para simplificar equa√ß√µes com fra√ß√µes, o objetivo principal √© eliminar os denominadores."},{q:"A que matem√°tico do s√©c. XVII se atribui a unifica√ß√£o da √°lgebra e geometria (sistema de coordenadas cartesianas)?",options:["Ren√© Descartes","Isaac Newton","Carl Friedrich Gauss","Euclides"],correct:0,hint:"O nome do sistema de coordenadas mais comum √© uma homenagem a este pensador."},{q:"Como se classifica o comportamento da fun√ß√£o $g(x)=5-2x$?",options:["Crescente, pois aproxima-se de 5.","Decrescente, porque o coeficiente de $x$ √© negativo.","Constante.","Crescente, porque o termo independente √© positivo."],correct:1,hint:"O crescimento ou decrescimento depende exclusivamente do sinal do coeficiente angular."},{q:"Na equa√ß√£o $3(x-2)+5=14$, qual o resultado correto ap√≥s aplicar a propriedade distributiva?",options:["$3x-2+5=14$","$3x-6+5=14$","$3x-2=9$","$x-2+5=\\frac{14}{3}$"],correct:1,hint:"O n√∫mero fora do par√™ntese deve multiplicar todos os termos dentro dele."},{q:"Qual das seguintes representa a forma can√≥nica de uma equa√ß√£o do 1.¬∫ grau?",options:["$A(x)=B(x)$","$y=mx+b$","$ax+b=0$","$ax^2+bx+c=0$"],correct:2,hint:"A forma can√≥nica expressa a equa√ß√£o igualada a zero."}];
        
        // --- FLASHCARDS DATA UPDATED ---
        const flashcardsData = [
            {q:"Defini√ß√£o de Equa√ß√£o",a:"Equa√ß√£o √© uma igualdade em que aparece uma letra (ou mais) que representa um valor desconhecido. √Ä letra que representa o valor desconhecido chama-se inc√≥gnita."},
            {q:"Forma Can√≥nica",a:"ax + b = 0"},{q:"Condi√ß√£o de Exist√™ncia",a:"a ‚â† 0"},{q:"Inc√≥gnita (x)",a:"Valor desconhecido a determinar."},{q:"Coeficiente Angular (a)",a:"Multiplica o x."},{q:"Termo Independente (b)",a:"N√£o depende de x."},{q:"Raiz",a:"Valor que torna a igualdade verdadeira."},{q:"Princ√≠pio Aditivo",a:"Adicionar/subtrair o mesmo valor a ambos os lados."},{q:"Regra da Transposi√ß√£o",a:"Mudar de membro inverte a opera√ß√£o."},{q:"Isolar a Inc√≥gnita",a:"Objetivo da resolu√ß√£o."},{q:"Sistema Imposs√≠vel (SI)",a:"Retas paralelas distintas."},{q:"Sistema Indeterminado (SPI)",a:"Retas coincidentes."}
        ];
        
        const vfData = [{q:"Forma can√≥nica √© $ax+b=0$.",c:true,f:"Correto!"},{q:"Coeficiente $a$ pode ser zero.",c:false,f:"Falso! Se a=0 n√£o h√° x."},{q:"Aditivo: somar passa a dividir.",c:false,f:"Falso! Somar passa a subtrair."},{q:"Raiz torna a igualdade verdadeira.",c:true,f:"Verdadeiro!"},{q:"A fun√ß√£o $f(x)=x$ designa-se por fun√ß√£o identidade.",c:true,f:"Verdadeiro! √â a fun√ß√£o linear mais simples."},{q:"Paralelas distintas = SPI.",c:false,f:"Falso! √â SI."},{q:"Solu√ß√£o de $x+3=0$ √© 3.",c:false,f:"Falso! √â -3."},{q:"Termo independente n√£o depende de x.",c:true,f:"Verdadeiro!"},{q:"$4x-8=3x+3 \\Rightarrow x=11$.",c:true,f:"Verdadeiro!"},{q:"Linguagem verbal √© irrelevante.",c:false,f:"Falso! √â crucial."}];
        const questions = [{id:1,phase:"Visual",text:"Equilibra a balan√ßa:",type:"balance",left:{boxes:1,units:2},right:{boxes:0,units:5},equation:"$$x + 2 = 5$$",answer:3,hint:"Retira 2 de cada lado.",explanation:"x = 3"},{id:2,phase:"Visual",text:"Equilibra a balan√ßa:",type:"balance",left:{boxes:1,units:4},right:{boxes:0,units:10},equation:"$$x + 4 = 10$$",answer:6,hint:"Retira 4 de cada lado.",explanation:"x = 6"},{id:3,phase:"Visual",text:"Caixas dos dois lados!",type:"balance",left:{boxes:2,units:0},right:{boxes:1,units:5},equation:"$$2x = x + 5$$",answer:5,hint:"Tira um x de cada lado.",explanation:"x = 5"},{id:4,phase:"M√°quina",text:"Inverso de multiplicar:",type:"machine",visual:"‚öôÔ∏è ( x 2 ) -> 8",equation:"$$2x = 8$$",answer:4,hint:"Divide por 2.",explanation:"x = 4"},{id:5,phase:"M√°quina",text:"Dois passos:",type:"machine",visual:"‚öôÔ∏è x 2 + 4 = 12",equation:"$$2x + 4 = 12$$",answer:4,hint:"Subtrai 4, depois divide.",explanation:"x = 4"},{id:6,phase:"Contexto",text:"Triplo menos 4 √© 23.",type:"text",visual:"üìù Contexto",equation:"$$3x - 4 = 23$$",answer:9,hint:"3x = 27",explanation:"x = 9"},{id:7,phase:"Contexto",text:"T√°xi: 2‚Ç¨ + 1,5‚Ç¨/km = 5‚Ç¨",type:"text",visual:"üöï T√°xi",equation:"$$1,5x + 2 = 5$$",answer:2,hint:"1,5x = 3",explanation:"x = 2"},{id:8,phase:"Mestre",text:"Fra√ß√µes:",type:"text",visual:"üèÜ Fra√ß√£o",visualHint:"Tira 1, depois multiplica.",equation:"$$\\frac{x}{2} + 1 = 5$$",answer:8,hint:"x/2 = 4",explanation:"x = 8"}];

        let currentFC=0,currentQuizIdx=0,quizScore=0,quizAnswers=[],activeQuizType="",isQuestionAnswered=false;
        let achievements={jornada:false,vf:false,quiz:false}, scores={jornada:0,vf:0,quiz:0};
        let currentQuestionIndex=0,score=0,lives=3,userAnswers=[],labState={xValue:5,left:{x:1,u:0},right:{x:0,u:5}};
        let availableBoardQuestions=[];

        // Logic implementations (Flashcards, Quiz, Jornada, Lab, Board, Memory, Domino, Bingo) - kept compact
        function startFlashcards(){ hideAllScreens(); document.getElementById('screen-flashcards').classList.remove('hidden'); currentFC=0; document.getElementById('fc-total').innerText=flashcardsData.length; loadFlashcard(); }
        function loadFlashcard(){ document.getElementById('fc-counter').innerText=currentFC+1; const c=document.querySelector('.flashcard-container'); c.classList.remove('flipped'); const btn=document.getElementById('fc-next-btn'); if(currentFC>=flashcardsData.length-1){ btn.innerText="üîÑ Reiniciar"; btn.onclick=()=>{currentFC=0;loadFlashcard();}; } else { btn.innerText="Pr√≥ximo ‚û°"; btn.onclick=nextFlashcard; } setTimeout(()=>{ document.getElementById('fc-front').innerText=flashcardsData[currentFC].q; document.getElementById('fc-back').innerHTML=flashcardsData[currentFC].a; typeset(); },200); }
        function flipFlashcard(){document.querySelector('.flashcard-container').classList.toggle('flipped');}
        function nextFlashcard(){if(currentFC<flashcardsData.length-1){currentFC++;loadFlashcard();}}
        function prevFlashcard(){if(currentFC>0){currentFC--;loadFlashcard();}}
        function startVF(){activeQuizType='VF';initQuiz();} function startQuiz(){activeQuizType='GENERAL';initQuiz();} function restartCurrentQuiz(){if(activeQuizType==='VF')startVF();else startQuiz();}
        function initQuiz(){hideAllScreens();currentQuizIdx=0;quizScore=0;quizAnswers=[];document.getElementById(activeQuizType==='VF'?'screen-vf':'screen-quiz').classList.remove('hidden');loadQuizQuestion();}
        function loadQuizQuestion(){const isVF=activeQuizType==='VF', ds=isVF?vfData:quizData, item=ds[currentQuizIdx]; isQuestionAnswered=false; const p=isVF?'vf':'quiz'; document.getElementById(`${p}-q-num`).innerText=currentQuizIdx+1; document.getElementById(`${p}-progress`).style.width=`${(currentQuizIdx/ds.length)*100}%`; document.getElementById(`${p}-question`).innerHTML=item.q; typeset(); if(!isVF)document.getElementById('quiz-hint-text').innerText=item.hint||""; document.getElementById(`${p}-feedback`).style.display='none'; document.getElementById(`${p}-next-btn`).classList.remove('hidden'); if(isVF){document.getElementById('vf-buttons').classList.remove('hidden');} else{ const d=document.getElementById('quiz-options'); d.innerHTML=''; d.style.pointerEvents='auto'; item.options.forEach((o,i)=>{ const b=document.createElement('button');b.className='btn btn-option';b.innerHTML=o;b.onclick=()=>checkQuizAnswer(i);d.appendChild(b); }); typeset(); }}
        function checkVF(v){checkQuizAnswer(v);}
        function checkQuizAnswer(v){const isVF=activeQuizType==='VF', ds=isVF?vfData:quizData, item=ds[currentQuizIdx], p=isVF?'vf':'quiz'; let cor=false, ft=""; isQuestionAnswered=true; if(isVF){ document.getElementById('vf-buttons').classList.add('hidden'); cor=(v===item.c); ft=item.f; } else{ cor=(v===item.correct); ft=cor?"Correto!":"Incorreto."; const d=document.getElementById('quiz-options'); d.style.pointerEvents='none'; const bs=d.querySelectorAll('button'); bs[v].classList.add(cor?'selected-correct':'selected-wrong'); if(!cor)bs[item.correct].classList.add('selected-correct'); } if(cor)quizScore++; const fb=document.getElementById(`${p}-feedback`); fb.innerHTML=`<strong>${cor?'Correto! üéâ':'Incorreto...'}</strong><br>${ft}`; fb.className=`feedback ${cor?'correct':'incorrect'}`; fb.style.display='block'; quizAnswers.push({q:item.q,userAns:isVF?(v?"V":"F"):(activeQuizType==='VF'?'':item.options[v]),correctAns:isVF?(item.c?"V":"F"):(activeQuizType==='VF'?'':item.options[item.correct]),isCorrect:cor,skipped:false}); typeset();}
        function nextVF(){handleNextButton();} function nextQuiz(){handleNextButton();}
        function handleNextButton(){ if(!isQuestionAnswered){const isVF=activeQuizType==='VF',ds=isVF?vfData:quizData,item=ds[currentQuizIdx]; quizAnswers.push({q:item.q,userAns:"Ignorada",correctAns:"",isCorrect:false,skipped:true});} const ds=activeQuizType==='VF'?vfData:quizData; currentQuizIdx++; if(currentQuizIdx<ds.length)loadQuizQuestion();else endQuiz(); }
        function endQuiz(){ hideAllScreens(); document.getElementById('screen-results-report').classList.remove('hidden'); const t=quizAnswers.length, c=quizAnswers.filter(a=>a.isCorrect).length, s=quizAnswers.filter(a=>a.skipped).length, w=t-c-s, pct=t>0?Math.round((c/t)*100):0; document.getElementById('res-score').innerText=`${c} / ${t}`; document.getElementById('res-accuracy').innerText=`${pct}%`; document.getElementById('res-correct').innerText=c; document.getElementById('res-wrong').innerText=w; document.getElementById('res-skipped').innerText=s; let h=""; quizAnswers.forEach((a,i)=>{ let ic="‚ùå",cl="#c0392b"; if(a.isCorrect){ic="‚úÖ";cl="#27ae60";} if(a.skipped){ic="‚è≠Ô∏è";cl="#856404";} h+=`<div class="review-item"><div class="review-q" style="color:${cl}">${ic} Q${i+1}</div><div style="font-size:0.9rem; margin-bottom:5px;">${a.q}</div><div class="review-status">Resp: <strong>${a.userAns}</strong><br>${!a.isCorrect&&!a.skipped?`<span style="color:#27ae60">Corr: <strong>${a.correctAns}</strong></span>`:''}</div></div>`; }); document.getElementById('res-review-list').innerHTML=h; document.getElementById('res-review-container').classList.add('hidden'); typeset(); if(activeQuizType==='VF'){achievements.vf=true;scores.vf=pct;}else{achievements.quiz=true;scores.quiz=pct;} }
        function toggleReview(){document.getElementById('res-review-container').classList.toggle('hidden');}
        function checkCertificateUnlock(){ if(achievements.jornada&&achievements.vf&&achievements.quiz){ const b=document.getElementById('btn-cert-main'); b.classList.remove('btn-disabled'); b.removeAttribute('disabled'); b.innerText="üèÜ Certificado (Desbloqueado!)"; } }
        function showCertificate(){ hideAllScreens(); document.getElementById('screen-certificate').classList.remove('hidden'); const now=new Date(); document.getElementById('cert-date').innerText="Data: "+now.toLocaleDateString(); document.getElementById('cert-score-jornada').innerText=scores.jornada; document.getElementById('cert-score-vf').innerText=scores.vf; document.getElementById('cert-score-quiz').innerText=scores.quiz; const g=Math.round((scores.jornada+scores.vf+scores.quiz)/3); let gr=""; if(g<=49)gr="Insuficiente";else if(g<=69)gr="Suficiente";else if(g<=89)gr="Bom";else if(g<=99)gr="Muito Bom";else gr="Excelente"; document.getElementById('cert-score-global').innerText=g; document.getElementById('cert-grade').innerText=gr; }
        function startGame(){ currentQuestionIndex=0; score=0; lives=3; userAnswers=[]; hideAllScreens(); document.getElementById('screen-game').classList.remove('hidden'); updateStats(); loadQuestion(); }
        function loadQuestion(){ const q=questions[currentQuestionIndex]; document.getElementById('level-indicator').innerText=`N√≠vel ${currentQuestionIndex+1}`; document.getElementById('progress-bar').style.width=`${((currentQuestionIndex)/questions.length)*100}%`; document.getElementById('feedback-area').style.display='none'; document.getElementById('btn-check').classList.remove('hidden'); document.getElementById('btn-next').classList.add('hidden'); document.getElementById('user-input').value=''; const h=document.getElementById('visual-hint-container'); h.innerHTML=''; h.classList.add('hidden'); const btnH=document.getElementById('btn-visual-hint'); q.visualHint?(btnH.classList.remove('hidden'),h.innerHTML=q.visualHint):btnH.classList.add('hidden'); document.getElementById('question-text').innerText=q.text; document.getElementById('question-equation').innerText=q.equation; const ba=document.getElementById('balance-area'); const va=document.getElementById('visual-text-area'); if(q.type==='balance'){va.classList.add('hidden');renderBalance(q.left,q.right,'balance-area');}else{ba.classList.add('hidden');va.classList.remove('hidden');va.innerHTML=q.visual;} typeset(); }
        function showVisualHint(){document.getElementById('btn-visual-hint').classList.add('hidden');document.getElementById('visual-hint-container').classList.remove('hidden');typeset();}
        function checkAnswer(){ const v=parseFloat(document.getElementById('user-input').value); const q=questions[currentQuestionIndex]; const fb=document.getElementById('feedback-area'); if(isNaN(v)){alert("Insere um n√∫mero.");return;} if(v===q.answer){score+=100+(lives*10);fb.innerHTML=`<strong>Correto!</strong> ${q.explanation}`;fb.className='feedback correct';userAnswers.push({id:q.id,correct:true});document.getElementById('btn-check').classList.add('hidden');document.getElementById('btn-next').classList.remove('hidden');}else{lives--;fb.innerHTML=`<strong>Errado...</strong> Dica: ${q.hint}`;fb.className='feedback incorrect';if(lives===0){endGame();return;}} fb.style.display='block';updateStats();typeset(); }
        function nextQuestion(){currentQuestionIndex++;if(currentQuestionIndex<questions.length)loadQuestion();else endGame();}
        function updateStats(){document.getElementById('score').innerText=score;document.getElementById('lives').innerText=lives;}
        function endGame(){ hideAllScreens(); document.getElementById('screen-report').classList.remove('hidden'); document.getElementById('final-score').innerText=score; let h="<ul>"; questions.forEach((q,i)=>{ const a=userAnswers.find(x=>x.id===q.id); h+=`<li>N√≠vel ${i+1}: ${a&&a.correct?'‚úÖ':'‚ùå'}</li>`; }); document.getElementById('report-details').innerHTML=h; document.getElementById('journey-review-container').classList.add('hidden'); const c=userAnswers.filter(a=>a.correct).length; const p=Math.round((c/questions.length)*100); achievements.jornada=true; scores.jornada=p; setTimeout(()=>typeset(),100); }
        function toggleJourneyReview(){document.getElementById('journey-review-container').classList.toggle('hidden');}
        function startLab(){hideAllScreens();document.getElementById('screen-lab').classList.remove('hidden');renderBalance({boxes:0,units:0},{boxes:0,units:0},'lab-balance-area');updateLab();}
        function adjustLab(s,t,d){if(labState[s][t]+d>=0){labState[s][t]+=d;updateLab();}}
        function updateLab(){ labState.xValue=parseInt(document.getElementById('lab-x-value').value); document.getElementById('lab-x-display').innerText=labState.xValue; ['left','right'].forEach(s=>{document.getElementById(`count-${s}-x`).innerText=labState[s].x;document.getElementById(`count-${s}-u`).innerText=labState[s].u;}); renderBalance({boxes:labState.left.x,units:labState.left.u},{boxes:labState.right.x,units:labState.right.u},'lab-balance-area'); const wL=(labState.left.x*labState.xValue)+labState.left.u; const wR=(labState.right.x*labState.xValue)+labState.right.u; const beam=document.getElementById('lab-balance-area-beam'); if(beam){beam.classList.remove('tilt-left','tilt-right','balanced');beam.classList.add(wL>wR?'tilt-left':(wR>wL?'tilt-right':'balanced'));} const term=(s)=>{const x=labState[s].x>0?(labState[s].x>1?`${labState[s].x}x`:'x'):'';const u=labState[s].u>0?(x?`+${labState[s].u}`:`${labState[s].u}`):'';return(x+u)||'0';}; const sym=wL>wR?'>':(wR>wL?'<':'='); const col=wL===wR?'#27ae60':'#e74c3c'; const eq=`$$ ${term('left')} \\quad \\color{${col}}{${sym}} \\quad ${term('right')} $$`; const el=document.getElementById('lab-equation'); el.innerHTML=eq; typeset(); }
        function renderBalance(l,r,id){ const c=document.getElementById(id); if(!c.querySelector('.balance-container')){c.innerHTML=`<div class="balance-container"><div class="balance-beam" id="${id}-beam"><div class="pan-string string-l1"></div><div class="pan-string string-l2"></div><div class="pan-plate plate-left" id="${id}-plate-left"></div><div class="pan-string string-r1"></div><div class="pan-string string-r2"></div><div class="pan-plate plate-right" id="${id}-plate-right"></div></div><div class="balance-fulcrum"></div></div>`;c.classList.remove('hidden');} const pl=document.getElementById(`${id}-plate-left`); pl.innerHTML=''; for(let i=0;i<l.boxes;i++)pl.innerHTML+=`<div class="weight-box">x</div>`; for(let i=0;i<l.units;i++)pl.innerHTML+=`<div class="weight-circle">1</div>`; const pr=document.getElementById(`${id}-plate-right`); pr.innerHTML=''; for(let i=0;i<r.boxes;i++)pr.innerHTML+=`<div class="weight-box">x</div>`; for(let i=0;i<r.units;i++)pr.innerHTML+=`<div class="weight-circle">1</div>`; }
        function startBoardGame(){ hideAllScreens(); document.getElementById('screen-game-board').classList.remove('hidden'); boardPos=0; availableBoardQuestions=[...questions]; renderBoard(); }
        function getBoardQuestion(){ if(availableBoardQuestions.length===0)availableBoardQuestions=[...questions]; const i=Math.floor(Math.random()*availableBoardQuestions.length); return availableBoardQuestions.splice(i,1)[0]; }
        function renderBoard(){ const c=document.getElementById('board-container'); c.innerHTML=''; for(let i=0;i<20;i++){ const cell=document.createElement('div'); cell.className='board-cell'; if(i===0){cell.innerText='Inicio';cell.classList.add('start');}else if(i===19){cell.innerText='Fim';cell.classList.add('finish');}else{cell.innerText=i;} if(i===boardPos){const t=document.createElement('div');t.className='player-token';cell.appendChild(t);} c.appendChild(cell); } }
        function rollDice(){ const s=Math.floor(Math.random()*3)+1; boardQ=getBoardQuestion(); document.getElementById('modal-board-question').style.display='flex'; document.getElementById('board-q-text').innerHTML=`Avan√ßa <strong>${s}</strong> casas se resolveres:<br>${boardQ.equation}`; document.getElementById('board-input').value=''; document.getElementById('board-feedback').innerHTML=''; document.getElementById('board-input').focus(); document.getElementById('modal-board-question').dataset.steps=s; typeset(); }
        function checkBoardAnswer(){ const v=parseFloat(document.getElementById('board-input').value); const s=parseInt(document.getElementById('modal-board-question').dataset.steps); const fb=document.getElementById('board-feedback'); if(v===boardQ.answer){fb.innerHTML="<span style='color:green'>Correto! A avan√ßar...</span>"; setTimeout(()=>{document.getElementById('modal-board-question').style.display='none';boardPos+=s;if(boardPos>=19){boardPos=19;renderBoard();alert("Parab√©ns!");}else{renderBoard();}},1000);}else{fb.innerHTML="<span style='color:red'>Errado!</span>"; setTimeout(()=>{document.getElementById('modal-board-question').style.display='none';},1000);} }

        let memoryCards=[],flippedCards=[],memoryScore=0;
        // Updated Memory Pairs with Distinct Values (2 to 7)
        const memoryPairs=[{id:1,eq:"$$x+1=3$$",sol:"$$x=2$$"},{id:2,eq:"$$2x=6$$",sol:"$$x=3$$"},{id:3,eq:"$$x+2=6$$",sol:"$$x=4$$"},{id:4,eq:"$$2x=10$$",sol:"$$x=5$$"},{id:5,eq:"$$x-1=5$$",sol:"$$x=6$$"},{id:6,eq:"$$3x=21$$",sol:"$$x=7$$"}];
        function startMemoryGame(){ hideAllScreens(); document.getElementById('screen-game-memory').classList.remove('hidden'); document.getElementById('btn-restart-memory').classList.add('hidden'); memoryScore=0; document.getElementById('memory-score').innerText=0; flippedCards=[]; let deck=[]; memoryPairs.forEach(p=>{deck.push({id:p.id,c:p.eq});deck.push({id:p.id,c:p.sol});}); deck.sort(()=>Math.random()-0.5); const g=document.getElementById('memory-container'); g.innerHTML=''; deck.forEach((c,i)=>{ const el=document.createElement('div'); el.className='memory-card'; el.dataset.id=c.id; el.innerHTML='<span style="display:none">'+c.c+'</span><span>‚ùì</span>'; el.onclick=()=>flipCard(el,c.c); g.appendChild(el); }); typeset(); }
        function flipCard(el,content){ if(el.classList.contains('flipped')||el.classList.contains('matched')||flippedCards.length>=2)return; el.classList.add('flipped'); el.innerHTML='<div style="transform:rotateY(180deg);text-align:center;">'+content+'</div>'; typeset(); flippedCards.push(el); if(flippedCards.length===2){ if(flippedCards[0].dataset.id===flippedCards[1].dataset.id){ flippedCards.forEach(c=>c.classList.add('matched')); memoryScore++; document.getElementById('memory-score').innerText=memoryScore; flippedCards=[]; if(memoryScore===memoryPairs.length)document.getElementById('btn-restart-memory').classList.remove('hidden'); }else{ setTimeout(()=>{flippedCards.forEach(c=>{c.classList.remove('flipped');c.innerHTML='<span>‚ùì</span>';});flippedCards=[];},1000); } } }

        let dominoHand=[],dominoTable=[];
        const dominoData=[{l:"In√≠cio",r:"$$x+1=3$$"},{l:"$$x=2$$",r:"$$2x=8$$"},{l:"$$x=4$$",r:"$$x-1=5$$"},{l:"$$x=6$$",r:"$$3x=15$$"},{l:"$$x=5$$",r:"$$x+x=10$$"},{l:"$$x=5$$",r:"$$4x=4$$"},{l:"$$x=1$$",r:"Fim"}];
        function startDominoGame(){ hideAllScreens(); document.getElementById('screen-game-domino').classList.remove('hidden'); document.getElementById('btn-restart-domino').classList.add('hidden'); document.getElementById('domino-msg').innerText=""; dominoTable=[]; dominoHand=[...dominoData]; dominoTable.push(dominoHand.shift()); dominoHand.sort(()=>Math.random()-0.5); renderDomino(); }
        function renderDomino(){ const t=document.getElementById('domino-table'); t.innerHTML=''; dominoTable.forEach(p=>t.innerHTML+=`<div class="domino-piece on-table"><div class="domino-half">${p.l}</div><div class="domino-half">${p.r}</div></div>`); const h=document.getElementById('domino-hand'); h.innerHTML=''; dominoHand.forEach((p,i)=>{ const d=document.createElement('div'); d.className='domino-piece'; d.innerHTML=`<div class="domino-half">${p.l}</div><div class="domino-half">${p.r}</div>`; d.onclick=()=>playDomino(i); h.appendChild(d); }); if(dominoHand.length===0){document.getElementById('domino-msg').innerText="Parab√©ns!";document.getElementById('btn-restart-domino').classList.remove('hidden');} typeset(); }
        function playDomino(i){ const p=dominoHand[i]; const last=dominoTable[dominoTable.length-1]; const sols={"$$x+1=3$$":"$$x=2$$","$$2x=8$$":"$$x=4$$","$$x-1=5$$":"$$x=6$$","$$3x=15$$":"$$x=5$$","$$x+x=10$$":"$$x=5$$","$$4x=4$$":"$$x=1$$"}; if(p.l===sols[last.r]){dominoHand.splice(i,1);dominoTable.push(p);document.getElementById('domino-msg').innerText="Boa jogada!";renderDomino();}else{document.getElementById('domino-msg').innerText="N√£o encaixa!";} }

        let bingoNumbers=[],bingoCalled=[],bingoCurrentTarget=null,bingoCurrentExpl="";
        function startBingoGame(){ hideAllScreens(); document.getElementById('screen-game-bingo').classList.remove('hidden'); bingoNumbers=[]; bingoCalled=[]; document.getElementById('bingo-current-call').innerHTML='...'; document.getElementById('bingo-status').innerText=''; document.getElementById('btn-next-bingo').classList.remove('hidden'); const pool=Array.from({length:20},(_,i)=>i+1).sort(()=>Math.random()-0.5); bingoNumbers=pool.slice(0,9); renderBingoCard(); }
        function renderBingoCard(){ const g=document.getElementById('bingo-card'); g.innerHTML=''; bingoNumbers.forEach(n=>{ const c=document.createElement('div'); c.className='bingo-cell'; c.innerText=n; c.onclick=()=>checkBingoClick(c,n); g.appendChild(c); }); }
        function nextBingoCall(){ let pool=Array.from({length:20},(_,i)=>i+1).filter(n=>!bingoCalled.includes(n)); if(pool.length===0){document.getElementById('bingo-status').innerText="Fim!";document.getElementById('btn-next-bingo').classList.add('hidden');return;} const t=pool[Math.floor(Math.random()*pool.length)]; bingoCalled.push(t); bingoCurrentTarget=t; const data=generateBingoEquation(t); bingoCurrentExpl=data.exp; const d=document.getElementById('bingo-current-call'); d.innerHTML=data.text; typeset(); document.getElementById('bingo-status').innerText="Procura na cartela!"; }
        function generateBingoEquation(r){ const t=Math.floor(Math.random()*3); if(t===0){const a=Math.floor(Math.random()*10)+1;return{text:`$$x + ${a} = ${r+a}$$`,exp:`Para isolar x, subtrai ${a}: $$x = ${r+a} - ${a} = ${r}$$`};}else if(t===1){const a=Math.floor(Math.random()*5)+1;return{text:`$$x - ${a} = ${r-a}$$`,exp:`Para isolar x, soma ${a}: $$x = ${r-a} + ${a} = ${r}$$`};}else{const a=Math.floor(Math.random()*4)+2;return{text:`$$${a}x = ${a*r}$$`,exp:`Divide por ${a}: $$x = \\frac{${a*r}}{${a}} = ${r}$$`};} }
        function checkBingoClick(c,n){ if(n===bingoCurrentTarget){ if(!c.classList.contains('marked')){ c.classList.add('marked'); const s=document.getElementById('bingo-status'); s.innerHTML="<span style='color:green;font-size:1.1rem;'>Correto! ‚úÖ</span><br>"+bingoCurrentExpl; typeset(); if(document.querySelectorAll('.bingo-cell.marked').length===9)alert("BINGO!"); } }else{ document.getElementById('bingo-status').innerHTML="<span style='color:red'>Errado!</span>"; } }
    </script>
</body>
</html>